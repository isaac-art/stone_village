<html>
<head>
    <title>DEMO</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<style>
    canvas{
        display: none;
    }
</style>
<body>
<canvas id="chartCanvas" style="display: block;max-width: 800px; max-height: 300px;"></canvas>
<div id="status"></div>
<div id="results"></div>
</body>

<script type="module">
import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.14.1';
import { EventCounter, Timer } from '/classes.js';

env.allowLocalModels = false;

const captureInterval = 100; 
const video = document.createElement('video');
// video.style.display = 'hide';
document.body.appendChild(video);

const canvas = document.createElement('canvas');
document.body.appendChild(canvas);
canvas.style.display = 'none';
const ctx = canvas.getContext('2d');

const status = document.getElementById('status');
const results = document.getElementById('results');

const classes = [
    'thumbs up', 'smiling', 'laughing', 
    'drinking', 'sitting', 'standing', 
    'yawning', 'leaning in'
];

const queries = [
    new EventCounter('thumbs up', 0.5, 200, 3000),
    new Timer('smiling', 0.5),
    new Timer('laughing', 0.5),
    new EventCounter('drinking', 0.5, 200, 3000),
    new Timer('sitting', 0.3),
    new Timer('standing', 0.3),
    new EventCounter('yawning', 0.3, 200, 3000),
    new Timer('leaning in', 0.2),
]

const chartCanvas = document.getElementById('chartCanvas');
let chart;
let chartData = {
    labels: [],
    datasets: classes.map(c => ({
        label: c,
        data: [],
        fill: false,
        borderColor: getRandomColor(), // Function to generate a random color
        tension: 0.1
    }))
};

let chartOptions = {
  scales: {
    y: {
      min: 0,
      max: 1,
    }
  }
};
results.textContent = classes.map(c => `${c}: 0`).join(', ');

// LOAD PIPELINE
status.textContent = 'Loading model...';
const pipe = await pipeline('zero-shot-image-classification');
status.textContent = 'Ready';
// FINISHED LOADING

async function detect(){
    let img = await canvasToImage(canvas);
    status.textContent = 'Analysing...';
    const out = await pipe(img.src, classes);
    // console.log(out)
    // results.textContent = out.map(x => `${x.label}: ${x.score.toFixed(3)}`).join(', ');
   
    const updatedResults = queries.map(query => {
        if (query instanceof EventCounter) {
            return `${query.queryString}: Events - ${query.events.length}`;
        } else if (query instanceof Timer) {
            return `${query.queryString}: Time - ${query.getElapsedTime()}ms`;
        }
    }).join(', ');

    results.textContent = updatedResults;
    queries.forEach(query => {
        const outcome = out.find(o => o.label === query.queryString);
        if (outcome) {
            query.update({ score: outcome.score });
        }
    });
    
    // UPDATE CHART
    if (chartData.labels.length >= 50) {
        chartData.labels.shift();
        chartData.datasets.forEach(dataset => dataset.data.shift());
    }
    chartData.labels.push(new Date().toLocaleTimeString());
    out.forEach(outcome => {
        const dataset = chartData.datasets.find(d => d.label === outcome.label);
        if (dataset) {
            dataset.data.push(outcome.score);
        }
    });
    chart.update();
    status.textContent = 'Ready';

    setTimeout(detect, captureInterval);
}

function drawToCanvas() {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    }
    requestAnimationFrame(drawToCanvas);
}

function canvasToImage(canvas) {
    return new Promise(resolve => {
        const image = new Image();
        image.onload = () => resolve(image);
        image.src = canvas.toDataURL();
    });
}

function initializeChart() {
    chart = new Chart(chartCanvas, {
        type: 'line',
        data: chartData,
        options: chartOptions
    });
}

function getRandomColor() {
    const letters = '0123456789ABCDEF';
    let color = '#';
    for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
}


// ----------------- BEGIN -----------------
initializeChart();

navigator.mediaDevices.getUserMedia({ video: true })
.then(stream => {
    video.srcObject = stream;
    video.play();
    drawToCanvas();
    detect();
})
.catch(err => {
    console.error("Error accessing webcam:", err);
});

</script>


</html>